---
title: "IntroToR"
author: "BIGsummer"
date: "6/23/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

## R Markdown and Code Chunks

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r NameOfChunk, include = TRUE}

# This is a code chunk. 

```

```{r ExampleChunk, warning=FALSE, include=FALSE}

# Include = FALSE means the code for this will not show up in the final report, change this to TRUE and see what happens.

# Warning = FALSE means that any warnings that come up while the code is running will not be displayed. 

# Within code chunks, the R code will be interpreted. Outside the code chunks it will not.

# Outside the code chunks you can type in text and heading using Markdown to format and organize reports.

# Create new headings outside the code chunch with one or more # symbols. For example, copy and paste this code outside the code chunk and see what it does:

# Heading 1
## Heading 2
### Heading 3
#### Heading 4, etc...

# In the R markdown CheatSheet you will find a number of useful formatting commands for your text. 

```

In this lesson we will learn to install and load the packages necessary to do data analysis in R.

```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# This code chunk will load all the packages needed for this document. 

# For reports like this, it is best to install the necessary packages and load the libraries first. That way you know ahead of time if you are going to run into any issues with operations later on.

library('tidyr')
library('dplyr')
library('tibble')
library('RColorBrewer')
library('pheatmap')
library('ggplot2')
library('lubridate')

```

## Importing Data and Selecting Columns

We will learn to import data into R and reshape it into formats that are useful for data visualization. For our research question, we will work with public COVD19 data to visualize the number of COVID19 cases per million for every state in the form of a heatmap and imagine other ways we would want to visualize this kind of information. 

```{r DataImport, include = TRUE}

# This is just repeating the commands that we did in the first day(s) to import our data.

alldata <- read.csv("us_states_covid19_daily.csv", sep = ",")
statepop <- read.csv("States.csv", sep = ",")

selectedpops <- data.frame(statepop$StateAbbreviation, statepop$Pop.millions) %>% 
  rename(State = statepop.StateAbbreviation, Population = statepop.Pop.millions)
```

## Data Wrangling and Cleaning

We will learn to handle imperfect data sets, calculate new columns, clean and rename data for downstream uses.

```{r wrangling1, include = TRUE}
# Merging the tables
tablemerge <- left_join(selectedpops, alldata, by = c("State"="state"))

# Cleaning the data
casespermillion <- tablemerge %>%
  mutate(Log2_CPM = log2(positive/Population)) %>% 
  filter(Population != "NA") %>%
  filter(Log2_CPM != -Inf)

# Selecting and renaming columns, forplotting will be used for multiple types of plots.
forplotting <- casespermillion %>%
  select(date, State, Log2_CPM, positive, Population)

```

## Visualizing with heatmaps

In this lesson, we will learn to restructure our data in order to work with data visualization packages. 

```{r heatmap1, include = TRUE}

# Reshaping the data frame based on State and Date information
forheatmapcpm <- forplotting %>%
  select(State, date, Log2_CPM) %>%
  group_by(State, date) %>%
  spread(key = date, value = Log2_CPM) 

# Cleaning and Trimming the Data set
forheatmapcpm <- column_to_rownames(forheatmapcpm, var = "State")
forheatmapcpm[is.na(forheatmapcpm)] <- min(forheatmapcpm, na.rm=TRUE)

forheatmaptrim <- forheatmapcpm[
  which(colnames(forheatmapcpm)=="20200420"):(ncol(forheatmapcpm))
  ]

# Creating the matrix
mymatrix <- as.matrix(forheatmaptrim)

# Perparing for Visualization
mybreaks <- as.integer(min(forheatmaptrim-1)):as.integer(max(forheatmaptrim))

# Syntax for pheatmap()
cpmplot <- pheatmap(
  mymatrix, 
  scale="none", 
  cluster_cols = FALSE, 
  breaks = mybreaks, 
  color = colorRampPalette(brewer.pal(9, "Purples"))(length(mybreaks)),
  border_color = NA,
  fontsize_col = 4,
  fontsize_row = 5,
  main = "Log2(COVID Cases per Million) across the states"
  )

```

## Data Visualization with ggplot2

We will learn about the grammar of graphics and use ggplot2 to create some common plots.

```{r message=FALSE, warning=FALSE}

# Selecting the data
forplotting <- casespermillion %>%
  select(date, State, Log2_CPM, positive) 

# Pick a state
justca <- forplotting %>%
  filter(State == "CA") 

# The Plot
plot <- ggplot(justca, aes(x = ymd(date), y = positive, color = State)) +
  geom_smooth(method = "auto") +
  geom_point(size = 0.1, alpha = 1, color = "black") +
  labs( x = "Days since first recorded case", y = "Number of Positive Cases", title = "Covid Cases in CA")

plot

```

We can study the growth of the pandemic over time in a particular state. Or we can view the average number of new positive cases per day of the most populous states over the month of August.

```{r message=FALSE, warning=FALSE}

# Selecting the data
forplotting <- casespermillion %>%
  select(date, State, positiveIncrease, Population) 

# Filter your states. 
bigstates <- forplotting %>%
  filter(Population > 10) %>% # with populations over 10 Million
  mutate(NewCasesPerMillion = positiveIncrease/Population)

# Filter the dates
forplotting <- bigstates %>%
  filter(date > 20200801) # any day after 2020-08-01


ggplot(data = forplotting, aes(State, NewCasesPerMillion, fill = State))+
  geom_violin(scale = "area")+
  geom_dotplot(binaxis="y", stackdir = "center", dotsize = .5, fill = "black", alpha = 0.8) + 
  scale_fill_brewer(palette = "Greens") + 
  labs( y = "New cases per day", title = "New cases per day per million since Aug 01")+
  scale_y_log10()
  

```

## How else would you do it?

``` {r YourPlotHere, include = FALSE}


```


